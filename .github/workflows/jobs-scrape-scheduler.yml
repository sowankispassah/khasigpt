name: Jobs Scrape Scheduler

on:
  schedule:
    # Hourly trigger for Hobby plan (external scheduler instead of Vercel cron)
    - cron: "5 * * * *"
  workflow_dispatch:

jobs:
  trigger-scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Validate required secrets
        env:
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          JOBS_SCRAPE_SECRET: ${{ secrets.JOBS_SCRAPE_SECRET }}
        run: |
          if [ -z "$APP_BASE_URL" ]; then
            echo "Missing secret: APP_BASE_URL"
            exit 1
          fi
          if [ -z "$JOBS_SCRAPE_SECRET" ]; then
            echo "Missing secret: JOBS_SCRAPE_SECRET"
            exit 1
          fi

      - name: Trigger jobs scrape endpoint
        env:
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          JOBS_SCRAPE_SECRET: ${{ secrets.JOBS_SCRAPE_SECRET }}
        run: |
          set -euo pipefail
          BASE_URL="${APP_BASE_URL%/}"
          curl --fail --show-error --silent \
            -X POST \
            -H "x-scrape-token: $JOBS_SCRAPE_SECRET" \
            "$BASE_URL/api/jobs/scrape?trigger=auto"
          echo "Scrape trigger sent successfully."
